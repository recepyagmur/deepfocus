<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Focus | Pro Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        /* --- CSS AYARLARI --- */
        :root {
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --card-bg: rgba(30, 41, 59, 0.85);
            --card-border: rgba(255, 255, 255, 0.1);
            --text-main: #f1f5f9; --text-muted: #94a3b8; --accent: #eab308;
            --success: #10b981; --danger: #ef4444;
            --cat-work: #3b82f6; --cat-study: #a855f7; --cat-sport: #f97316; --cat-personal: #ec4899;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg-gradient); color: var(--text-main); min-height: 100vh; margin: 0; display: flex; justify-content: center; align-items: center; padding: 20px; }

        .container { background: var(--card-bg); backdrop-filter: blur(20px); width: 100%; max-width: 650px; border-radius: 24px; border: 1px solid var(--card-border); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6); padding: 40px; position: relative; overflow: hidden; }
        .glow-spot { position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: var(--accent); filter: blur(80px); opacity: 0.2; border-radius: 50%; z-index: 0; }

        header { position: relative; z-index: 1; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: flex-start; }
        header h1 { font-size: 28px; font-weight: 700; margin: 0; background: linear-gradient(to right, #fff, #cbd5e1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .quote { font-size: 13px; color: var(--text-muted); font-style: italic; margin-top: 8px; border-left: 2px solid var(--accent); padding-left: 10px; max-width: 400px; }
        .streak-badge { background: rgba(239, 68, 68, 0.15); color: #fca5a5; padding: 8px 12px; border-radius: 12px; font-size: 13px; font-weight: 700; display: none; align-items: center; gap: 6px; border: 1px solid rgba(239, 68, 68, 0.3); }

        .progress-container { margin-bottom: 25px; position: relative; z-index: 1; }
        .progress-track { height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; border-radius: 10px; transition: width 0.6s; }
        .progress-labels { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-muted); }

        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; position: relative; z-index: 1; }
        .full-width { grid-column: span 2; }
        input, select { background: rgba(0, 0, 0, 0.3); border: 1px solid var(--card-border); padding: 14px; border-radius: 12px; color: #fff; font-family: inherit; outline: none; width: 100%; transition: 0.3s; }
        input:focus, select:focus { border-color: var(--accent); background: rgba(0, 0, 0, 0.5); }
        input[type="time"]::-webkit-calendar-picker-indicator, input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }

        button#addBtn { grid-column: span 2; background: var(--accent); color: #0f172a; border: none; padding: 15px; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        button#addBtn:hover { transform: translateY(-2px); }

        ul { list-style: none; padding: 0; margin: 30px 0 0 0; max-height: 450px; overflow-y: auto; }
        ul::-webkit-scrollbar { width: 4px; }
        ul::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        li { background: rgba(255, 255, 255, 0.04); margin-bottom: 12px; padding: 16px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); display: grid; grid-template-columns: auto 1fr auto auto; gap: 12px; align-items: center; position: relative; }

        .drag-handle { color: var(--text-muted); cursor: grab; padding: 5px; opacity: 0.5; font-size: 18px; }
        li::before { content: ''; position: absolute; left: 0; top: 16px; bottom: 16px; width: 4px; background: var(--text-muted); border-radius: 0 4px 4px 0; }
        li.cat-work::before { background: var(--cat-work); } li.cat-study::before { background: var(--cat-study); }
        li.cat-sport::before { background: var(--cat-sport); } li.cat-personal::before { background: var(--cat-personal); }
        li.completed { opacity: 0.5; order: 999; } li.completed .task-text { text-decoration: line-through; color: var(--text-muted); }

        .task-info { cursor: pointer; }
        .badges { display: flex; gap: 8px; margin-bottom: 6px; flex-wrap: wrap;}
        .badge { font-size: 10px; text-transform: uppercase; padding: 4px 8px; border-radius: 6px; font-weight: 700; }
        .badge-cat { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }
        .badge-time { background: rgba(234, 179, 8, 0.15); color: var(--accent); }
        .badge-worked { background: rgba(16, 185, 129, 0.15); color: #34d399; display: none; }

        .task-text { font-size: 16px; font-weight: 500; display: block; }

        .timer-box { display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.2); padding: 5px 12px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.05); }
        .timer-display { font-family: monospace; font-size: 14px; font-weight: 700; color: var(--text-muted); width: 70px; text-align: center; }
        .timer-active { color: var(--accent); text-shadow: 0 0 10px rgba(234, 179, 8, 0.4); }
        .timer-btn { background: var(--text-main); color: #0f172a; border: none; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .timer-btn:hover { background: var(--accent); }

        .delete-btn { background: transparent; border: none; color: var(--danger); font-size: 18px; cursor: pointer; opacity: 0.4; padding: 5px; }
        .delete-btn:hover { opacity: 1; }
        .empty-state { text-align: center; color: var(--text-muted); margin-top: 40px; font-weight: 300; opacity: 0.6; }
    </style>
</head>
<body>

    <div class="container">
        <div class="glow-spot"></div>

        <header>
            <div class="header-content">
                <h1>Deep Focus | Pro</h1>
                <div class="quote" id="quoteBox">Y√ºkleniyor...</div>
            </div>
            <div class="streak-badge" id="streakBadge">üî• <span>0 G√ºn</span></div>
        </header>

        <div class="progress-container">
            <div class="progress-labels">
                <span id="progressText">%0 Tamamlandƒ±</span>
                <span id="countText">0/0 G√∂rev</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="progressBar"></div>
            </div>
        </div>

        <div class="input-grid">
            <input type="date" id="taskDate">
            <select id="taskCategory">
                <option value="other">Genel</option>
                <option value="work">üíº ƒ∞≈ü</option>
                <option value="study">üìö Okul</option>
                <option value="sport">üí™ Spor</option>
                <option value="personal">üè† Ki≈üisel</option>
            </select>
            <input type="time" id="startTime">
            <input type="time" id="endTime">
            <input type="text" id="taskInput" class="full-width" placeholder="Hedefin nedir?" onkeypress="handleEnter(event)">
            <button id="addBtn" onclick="addTask()">PLANLA VE BA≈ûLA</button>
        </div>

        <ul id="taskList"></ul>
        <div id="emptyMessage" class="empty-state">Y√ºkleniyor...</div>
    </div>

    <audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

    <script>
        const API_URL = 'api.php';
        // Aktif saya√ßlarƒ±n interval ID'lerini tutar
        const activeIntervals = {};
        let tasksData = [];

        document.addEventListener('DOMContentLoaded', () => { initApp(); });

        function initApp() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('taskDate');
            dateInput.value = today;
            dateInput.addEventListener('change', () => { renderTasks(tasksData); });

            const now = new Date();
            const h = String(now.getHours()).padStart(2,'0');
            const m = String(now.getMinutes()).padStart(2,'0');
            document.getElementById('startTime').value = `${h}:${m}`;

            now.setHours(now.getHours() + 1);
            const he = String(now.getHours()).padStart(2,'0');
            const me = String(now.getMinutes()).padStart(2,'0');
            document.getElementById('endTime').value = `${he}:${me}`;

            loadQuote();
            fetchTasks();
            initSortable();
        }

        async function loadQuote() {
            try {
                const response = await fetch('quotes.json');
                const quotes = await response.json();
                const dayIndex = Math.floor(Date.now() / 86400000);
                document.getElementById('quoteBox').textContent = `"${quotes[dayIndex % quotes.length]}"`;
            } catch (e) { document.getElementById('quoteBox').textContent = '"Ba≈üarƒ± bir yolculuktur."'; }
        }

        function handleEnter(e) { if (e.key === 'Enter') addTask(); }

        function initSortable() {
            const el = document.getElementById('taskList');
            Sortable.create(el, {
                animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost',
                onEnd: function () { saveNewOrder(); }
            });
        }
        function saveNewOrder() { /* Backend sƒ±ralama opsiyonel */ }

        // --- VERƒ∞ √áEKME & BA≈ûLATMA ---
        async function fetchTasks() {
            try {
                const res = await fetch(API_URL);
                tasksData = await res.json();

                // Sayfa a√ßƒ±ldƒ±ƒüƒ±nda "√áalƒ±≈üƒ±yor" g√∂r√ºnenleri tekrar tetikle
                // Burasƒ± sihrin ger√ßekle≈ütiƒüi yer: Kapanƒ±p a√ßƒ±lsa bile buradan devam eder
                tasksData.forEach(task => {
                    if (task.isRunning) {
                        startUIInterval(task.id);
                    }
                });

                calculateStreak(tasksData);
                renderTasks(tasksData);
            } catch (e) { document.getElementById('emptyMessage').textContent = "Hata olu≈ütu."; }
        }

        async function saveTasks(tasks, shouldRender = true) {
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(tasks)
                });
                tasksData = tasks;
                calculateStreak(tasksData);
                if(shouldRender) renderTasks(tasks);
            } catch (e) { console.error("Kayƒ±t hatasƒ±"); }
        }

        async function addTask() {
            const text = document.getElementById('taskInput').value.trim();
            const start = document.getElementById('startTime').value;
            const end = document.getElementById('endTime').value;
            const selectedDate = document.getElementById('taskDate').value;

            if (!text || !start || !end) return alert("Eksik bilgi.");
            if (start >= end) return alert("Saat hatasƒ±.");

            document.getElementById('addBtn').disabled = true;

            const task = {
                id: Date.now(),
                text: text,
                date: selectedDate,
                category: document.getElementById('taskCategory').value,
                startTime: start,
                endTime: end,

                // KRƒ∞Tƒ∞K VERƒ∞LER
                elapsedTime: 0,       // Toplam birikmi≈ü s√ºre
                isRunning: false,     // √áalƒ±≈üƒ±yor mu?
                lastStartTime: null,  // En son ne zaman ba≈ülatƒ±ldƒ±?

                completed: false,
                completedAt: null
            };

            const newTasks = [task, ...tasksData];
            await saveTasks(newTasks);

            document.getElementById('taskInput').value = '';
            document.getElementById('addBtn').disabled = false;
        }

        async function toggleTask(id) {
            const t = tasksData.find(x => x.id === id);
            if(t) {
                if(t.isRunning) toggleTimer(id); // Tamamlanƒ±nca sayacƒ± durdur
                t.completed = !t.completed;
                t.completedAt = t.completed ? new Date().toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}) : null;
                saveTasks(tasksData);
            }
        }

        async function deleteTask(id) {
            if (activeIntervals[id]) clearInterval(activeIntervals[id]);
            if(confirm("Silinsin mi?")) {
                const newTasks = tasksData.filter(t => t.id !== id);
                saveTasks(newTasks);
            }
        }

        // --- ZAMANLAYICI MANTIƒûI (ARKA PLAN DESTEKLƒ∞) ---

        function getDurationSeconds(start, end) {
            const [h1, m1] = start.split(':').map(Number);
            const [h2, m2] = end.split(':').map(Number);
            return (h2 * 3600 + m2 * 60) - (h1 * 3600 + m1 * 60);
        }

        function formatTime(seconds) {
            if (seconds < 0) seconds = 0;
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h > 0 ? h + ':' : ''}${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        // En √∂nemli fonksiyon: ≈ûu anki ger√ßek ge√ßen s√ºreyi hesaplar
        function calculateTotalElapsed(task) {
            let total = task.elapsedTime || 0;
            // Eƒüer √ßalƒ±≈üƒ±yorsa: (Eski Biriken) + (≈ûu an - Ba≈ülangƒ±√ß Zamanƒ±)
            if (task.isRunning && task.lastStartTime) {
                const currentSession = (Date.now() - task.lastStartTime) / 1000;
                total += currentSession;
            }
            return total;
        }

        function toggleTimer(id) {
            const task = tasksData.find(t => t.id === id);
            if (!task) return;

            if (task.isRunning) {
                // DURDURMA: S√ºreyi sabitle ve kaydet
                const sessionSeconds = (Date.now() - task.lastStartTime) / 1000;
                task.elapsedTime += sessionSeconds;

                task.isRunning = false;
                task.lastStartTime = null;

                if (activeIntervals[id]) {
                    clearInterval(activeIntervals[id]);
                    delete activeIntervals[id];
                }
                updateTimerUI(id, false);

            } else {
                // BA≈ûLATMA: Sadece bir tane √ßalƒ±≈üabilir
                tasksData.forEach(t => {
                    if (t.id !== id && t.isRunning) toggleTimer(t.id);
                });

                task.isRunning = true;
                task.lastStartTime = Date.now(); // Zaman damgasƒ±nƒ± vur

                startUIInterval(id);
            }

            // Durumu sunucuya kaydet (Kesinti olursa buradan devam eder)
            saveTasks(tasksData, false);
        }

        // Ekranda sayacƒ± ilerleten g√∂rsel fonksiyon
        function startUIInterval(id) {
            if (activeIntervals[id]) clearInterval(activeIntervals[id]);
            updateTimerUI(id, true);

            activeIntervals[id] = setInterval(() => {
                const task = tasksData.find(t => t.id === id);
                if (!task || !task.isRunning) {
                    clearInterval(activeIntervals[id]);
                    return;
                }

                const totalTarget = getDurationSeconds(task.startTime, task.endTime);
                const currentElapsed = calculateTotalElapsed(task);

                // Kalan S√ºre (Geri Sayƒ±m)
                let remaining = totalTarget - currentElapsed;

                // S√ºre biterse 00:00'da kal, negatife d√º≈üme
                if (remaining <= 0) {
                    remaining = 0;
                    // Tam bittiƒüi saniye ses √ßal
                    if (remaining === 0 && (Math.abs(currentElapsed - totalTarget) < 1)) {
                         document.getElementById('alarmSound').play().catch(e=>{});
                    }
                }

                // UI G√ºncelleme
                const display = document.getElementById(`timer-${id}`);
                const workedBadge = document.getElementById(`worked-${id}`);

                if (display) display.textContent = formatTime(remaining);
                if (workedBadge) {
                    workedBadge.style.display = 'inline-block';
                    // √áalƒ±≈üƒ±lan s√ºre sonsuza kadar artmaya devam eder
                    workedBadge.textContent = `‚ö° ${Math.floor(currentElapsed / 60)}dk √áalƒ±≈üƒ±ldƒ±`;
                }

            }, 1000);
        }

        function updateTimerUI(id, isRunning) {
            const btn = document.getElementById(`btn-${id}`);
            const display = document.getElementById(`timer-${id}`);
            if (btn) btn.innerHTML = isRunning ? "‚è∏" : "‚ñ∂";
            if (display) {
                if(isRunning) display.classList.add('timer-active');
                else display.classList.remove('timer-active');
            }
        }

        // --- RENDER ---
        function renderTasks(allTasks) {
            const list = document.getElementById('taskList');
            const emptyMsg = document.getElementById('emptyMessage');
            const selectedDate = document.getElementById('taskDate').value;
            const filteredTasks = allTasks.filter(task => task.date === selectedDate);

            list.innerHTML = '';

            if (filteredTasks.length === 0) {
                emptyMsg.style.display = 'block';
                emptyMsg.textContent = selectedDate === new Date().toISOString().split('T')[0] ? "Bug√ºn i√ßin plan yok." : "Kayƒ±t yok.";
            } else {
                emptyMsg.style.display = 'none';
            }

            const completedCount = filteredTasks.filter(t => t.completed).length;
            updateProgress(completedCount, filteredTasks.length);

            filteredTasks.forEach(task => {
                const li = document.createElement('li');
                li.setAttribute('data-id', task.id);
                if (task.completed) li.classList.add('completed');
                li.classList.add(`cat-${task.category || 'other'}`);

                // Render anƒ±nda doƒüru s√ºreyi hesapla (Sayfa yenilendiƒüinde burasƒ± √ßalƒ±≈üƒ±r)
                const totalTarget = getDurationSeconds(task.startTime, task.endTime);
                const currentElapsed = calculateTotalElapsed(task);
                let remaining = totalTarget - currentElapsed;
                if (remaining < 0) remaining = 0;

                const workedMinutes = Math.floor(currentElapsed / 60);
                const showWorked = workedMinutes > 0 ? 'inline-block' : 'none';

                const btnIcon = task.isRunning ? "‚è∏" : "‚ñ∂";
                const activeClass = task.isRunning ? "timer-active" : "";

                li.innerHTML = `
                    <div class="drag-handle">‚ãÆ‚ãÆ</div>
                    <div class="task-info" onclick="toggleTask(${task.id})">
                        <div class="badges">
                            <span class="badge badge-cat">${getCatLabel(task.category)}</span>
                            <span class="badge badge-time">${task.startTime}-${task.endTime}</span>
                            <span class="badge badge-worked" id="worked-${task.id}" style="display: ${showWorked}">‚ö° ${workedMinutes}dk √áalƒ±≈üƒ±ldƒ±</span>
                        </div>
                        <span class="task-text">${task.text}</span>
                        <div class="completed-msg">‚úÖ Tamamlandƒ±</div>
                    </div>
                    ${!task.completed ? `
                    <div class="timer-box">
                        <div class="timer-display ${activeClass}" id="timer-${task.id}">${formatTime(remaining)}</div>
                        <button class="timer-btn" id="btn-${task.id}" onclick="toggleTimer(${task.id})">${btnIcon}</button>
                    </div>` : '<div></div>'}
                    <button class="delete-btn" onclick="deleteTask(${task.id})">‚úï</button>
                `;
                list.appendChild(li);
            });
        }

        function getCatLabel(c) {
            const map = { 'work':'ƒ∞≈ü', 'study':'Okul', 'sport':'Spor', 'personal':'Ki≈üisel', 'other':'Genel' };
            return map[c] || 'Genel';
        }

        function updateProgress(done, total) {
            const bar = document.getElementById('progressBar');
            const pct = total === 0 ? 0 : Math.round((done / total) * 100);
            bar.style.width = `${pct}%`;
            document.getElementById('progressText').textContent = `%${pct} Tamamlandƒ±`;
            document.getElementById('countText').textContent = `${done}/${total} G√∂rev`;
            bar.style.backgroundColor = pct === 100 ? '#10b981' : '#eab308';
        }

        function calculateStreak(tasks) {
            const completedDates = [...new Set(tasks.filter(t => t.completed).map(t => t.date))].sort().reverse();
            if (completedDates.length === 0) { document.getElementById('streakBadge').style.display = 'none'; return; }
            const today = new Date().toISOString().split('T')[0];
            let streak = 0;
            let check = new Date();
            if(!completedDates.includes(today)) check.setDate(check.getDate() - 1);
            while(true) {
                if(completedDates.includes(check.toISOString().split('T')[0])) { streak++; check.setDate(check.getDate() - 1); }
                else break;
            }
            if(streak > 0) {
                const b = document.getElementById('streakBadge');
                b.style.display = 'flex';
                b.querySelector('span').textContent = `${streak} G√ºnl√ºk Seri`;
            }
        }
    </script>
</body>
</html>
